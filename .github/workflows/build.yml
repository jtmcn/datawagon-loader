name: Build
permissions:
  contents: read

on:
    push:
      branches: [main]
    pull_request:
      branches: [main]

defaults:
  run:
    shell: bash

jobs:
  shellcheck-linting:
    name: Shell script linting
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Run shellcheck
        run: shellcheck setup-venv.sh update-venv.sh update.sh

  batch-syntax-check:
    name: Batch script syntax validation
    runs-on: 'windows-latest'
    steps:
      - uses: actions/checkout@v4
      - name: Validate batch syntax
        run: |
          # Basic batch syntax checks
          $errors = 0
          Get-ChildItem -Filter *.bat | ForEach-Object {
              Write-Host "Checking $_..."
              # Check for common syntax errors
              $content = Get-Content $_.FullName -Raw

              # Check for unmatched parentheses
              $openParen = ([regex]::Matches($content, '\(')).Count
              $closeParen = ([regex]::Matches($content, '\)')).Count
              if ($openParen -ne $closeParen) {
                  Write-Host "ERROR: Unmatched parentheses in $($_.Name)"
                  $errors++
              }

              # Check for CRLF line endings (required for batch)
              if ($content -notmatch "`r`n") {
                  Write-Host "WARNING: $($_.Name) may not have Windows line endings"
              }
          }

          if ($errors -gt 0) {
              Write-Host "Found $errors batch syntax error(s)"
              exit 1
          }
          Write-Host "All batch files passed syntax checks"
        shell: pwsh

  black-formatting-check:
    name: Check formatting
    runs-on: 'ubuntu-latest'
    needs: [shellcheck-linting, batch-syntax-check]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: psf/black@stable

  mypy-type-checking:
    name: Type checking
    runs-on: 'ubuntu-latest'
    needs: black-formatting-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
      - name: Install dependencies
        run: poetry install --with test
      - name: Run mypy
        run: poetry run mypy datawagon/ --config-file=pyproject.toml

  isort-import-check:
    name: Import sorting
    runs-on: 'ubuntu-latest'
    needs: mypy-type-checking
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
      - name: Install dependencies
        run: poetry install --with test
      - name: Run isort check
        run: poetry run isort --check-only --diff datawagon/ tests/

  security-scan:
    name: Security scanning
    runs-on: 'ubuntu-latest'
    needs: isort-import-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
      - name: Install dependencies
        run: poetry install
      - name: Run pip-audit
        run: |
          poetry run pip install pip-audit
          poetry run pip-audit --requirement requirements.txt

  vulture-dead-code-check:
    name: Dead code detection
    runs-on: 'ubuntu-latest'
    needs: security-scan
    continue-on-error: true  # Advisory mode - don't fail builds
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
      - name: Install dependencies
        run: poetry install --with dev
      - name: Run vulture
        run: poetry run vulture datawagon/ --min-confidence 70

  flake8-linting:
    name: Linting
    runs-on: 'ubuntu-latest'
    needs: vulture-dead-code-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: py-actions/flake8@v2

  build:
    name: Build tool
    runs-on: ${{ matrix.os }}
    needs: flake8-linting
    strategy:
      matrix:
        os:
          - 'ubuntu-latest'
          - 'macos-latest'
        python-version:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install poetry
        run: pipx install poetry
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.python-version}}
          cache: 'poetry'
      - name: Setup Poetry
        uses: abatilo/actions-poetry@v2
      - name: Get Poetry version
        run: poetry --version
      - name: Check pyproject.toml validity
        run: poetry check --no-interaction
      - name: Install deps
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --with test --without dev
      - name: Run tests with coverage
        run: poetry run pytest --cov=datawagon --cov-report=term --cov-report=xml --cov-fail-under=80 -v
      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: Build artifacts
        run: poetry build -v

  test-venv-installation:
    name: Test non-Poetry installation
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      matrix:
        os: ['ubuntu-latest', 'macos-latest', 'windows-latest']
        python-version: ['3.9', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.python-version}}

      - name: Run setup script (Windows)
        if: runner.os == 'Windows'
        run: |
          copy .env.example .env
          setup-venv.bat
        shell: cmd

      - name: Run setup script (Unix)
        if: runner.os != 'Windows'
        run: |
          cp .env.example .env
          ./setup-venv.sh

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        run: |
          .venv\Scripts\python.exe --version
          .venv\Scripts\datawagon.exe --help
          .venv\Scripts\python.exe -c "import click, pandas, pydantic, google.cloud.storage"
        shell: cmd

      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          python --version
          datawagon --help
          python -c "import click, pandas, pydantic, google.cloud.storage"

      - name: Test update script (Windows)
        if: runner.os == 'Windows'
        run: |
          update-venv.bat
          .venv\Scripts\datawagon.exe --help
        shell: cmd

      - name: Test update script (Unix)
        if: runner.os != 'Windows'
        run: |
          ./update-venv.sh
          source .venv/bin/activate
          datawagon --help

      - name: Verify dev tools NOT installed (Windows)
        if: runner.os == 'Windows'
        run: |
          .venv\Scripts\python.exe -c "import pytest" 2>nul && (
            echo ERROR: pytest should not be in runtime-only install
            exit /b 1
          ) || (
            echo ✓ Runtime-only installation verified
          )
        shell: cmd

      - name: Verify dev tools NOT installed (Unix)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          if python -c "import pytest" 2>/dev/null; then
            echo "ERROR: pytest should not be in runtime-only install"
            exit 1
          fi
          echo "✓ Runtime-only installation verified"

      - name: Test path with spaces (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir "test dir"
          cd "test dir"
          copy ..\.env.example .env
          copy ..\setup-venv.bat .
          copy ..\setup.py .
          copy ..\pyproject.toml .
          copy ..\README.md .
          xcopy ..\datawagon datawagon\ /E /I /Q
          setup-venv.bat
          if errorlevel 1 exit /b 1
          .venv\Scripts\datawagon.exe --help
          if errorlevel 1 exit /b 1
          echo ✓ Path with spaces test passed
        shell: cmd

      - name: Test path with spaces (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir "test dir"
          cd "test dir"
          cp ../.env.example .env
          cp ../setup-venv.sh .
          cp ../setup.py .
          cp ../pyproject.toml .
          cp ../README.md .
          cp -r ../datawagon .
          chmod +x setup-venv.sh
          ./setup-venv.sh
          source .venv/bin/activate
          datawagon --help
          echo "✓ Path with spaces test passed"